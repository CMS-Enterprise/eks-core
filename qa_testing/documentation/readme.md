# Quality Assurance (QA) Testing Framework

The _**qa_testing framework**_ is a collection of tools and scripts that can be used to test the quality of the codebase. The framework is designed with the end goal to be run in a CI/CD pipeline, but currently would be run locally against remote target clusters.

The _**qa_testing directory**_ is a self-contained directory that is designed to be run from any directory within the repo, but specifically with the intent to be run from the 'cluster' ( currently the 'example' ) directory. All bash scripts, python code, robot tests, and dependencies for these tools dynamically pull any remote GitHub or other community resources and build store them locally, self-contained within the _qa_testing_ directory.

The _**qa_testing framework**_ contains the following directories:

- **.3rd_party_tools** - contains external dependencies used by the qa_testing framework
- **configs** - contains qa_testing framework configuration files
- **documentation** - contains documentation files for the qa_testing framework
- **logs** - contains log files generated by the qa_testing framework
- **python** - contains qa_testing framework python code
- **robot** - contains qa_testing framework robot tests
- **scripts** - contains qa_testing framework bash scripts



## System Requirements
* **Awk** (version >= 5.1)
* **Aws-cli** (version >= 2.17)
* **Bash** (version >= 5.2)
* **Git** (version >= 2.45)
* **GNU** coreutils (version >= 8.32)
  * **Readlink**
  * **Sort**
  * **Tail**
  * **Uniq**
* **Grep** (version >= 3.7)
* **Ipcalc** (version >= 0.5)
* **Jq** (version >= 1.7)
* **Kubectl** (version >= v1.30)
* **Kustomize** (version >= v5.0)
* **Pip** (version >= 23.3)
* **Python** (version >= 3.10)
* **Robot** Framework (version >= 6.1)
* **Xargs** (version >= 4.8)

## Get set up

1.) Clone and run locally the Energon-Kube repo from this location:

```git@github.com:CMS-Enterprise/Energon-Kube.git```

2.) Ensure that the terminal is running a _**bash**_ shell and then set up the current terminal to leverage the QA Testing Framework by sourcing the .qa_bashrc file.  This enables the ability to call the QA Testing Framework Tools from the main cluster directory "<repo-root>/<cluster-directory>"  It places in the shell path the bash scripts.  The bash scripts contain validation scripts and scripts to call the python and robot framework tools.  The <repo-root> is the complete path to where **_Energon-Kube_** is cloned in the local system.

```
bash
cd <repo-root>/qa_testing
source .qa_bashrc
```

### Pre-Execution Authentication
* It is important to verify that your authentication to the target aws account is configured properly via your organizations process and that aws-cli and kubectl commands have the authentication enabled in the current bash shell.
* If you do not have a current target cluster up and running to perform the **_Smoke Test_** validation against, you can stand up a new cluster using the QA Framework's python **_bringup_cluster_** function.  See **_Example: Bringing up a cluster_** command below, or if the target cluster is already up and running, then proceeding directly to the **_Smoke Test run all_** command is appropriate.


### Running the tools

* Options in [ square ] brackets are optional
* Options in \< diaganal \> brackets are required

## QA Bash Scripts

Once the .qa_bashrc file has been sourced, change directory to the target cluster main configuration directory where everything is expected to be run.

```
cd <repo-root>/<cluster-directory>  # This is the 'example' directory
```
The **_QA Bash Scripts_** are now in the current bash shell path and can be called directly.  There are **_three types of bash scripts_**:

* Validation Scripts (Smoke Test)
* Script to Call QA Python Tools 
* Script to Call QA Robot Framework Tests

## Validation Scripts (Smoke Test)
There is a suite of validation scripts that can all be run from one command.  This is the preferred way to perform a complete **_Smoke Test_**:

### Example: Smoke Test "Run All"
Run from **_<repo-root>/<cluster-directory> $_**
```
run_all.sh <target-cluster-name>
```
Note: The run_all.sh Smoke Test will output its log file to the following directory `<repo-root>/qa_testing/logs/`  The file will be named `run_all.log`

#### List of Individual Validation Scripts:
* check_cluster_health.sh
* check_pods_triggering_errors.sh
* check_pods_withno_activelogs.sh
* check_pods_withno_activitylogs.sh
* EBSCSI_Check.sh
* EFSCSI_Check.sh
* fluentbit_check.sh
* loadbalncer_check.sh
* observability_check_enhanced.sh
* test_cordens.sh
* test_coredns.sh
* test_kubeproxy.sh
* test_pod_identity_agent.sh
* vpccni_check.sh

### Running an Individual Validation Script:

* There is additional documentation on the confluence page regarding each individual smoke test at this link [Cluster Validation Key Test Cases](https://confluenceent.cms.gov/pages/viewpage.action?spaceKey=BATCAVE&title=Cluster+Validation+Key+Test+cases)
* The confluence page has a table for each individual validation script which shows the documentation, reference to each testcase, the script-name, and any parameters to pass.
* Running the individual validation script will output its results to the terminal.

### Example: <script-name.sh>
Run from **_<repo-root>/<cluster-directory> $_**
```
<script-name.sh> <required-parameters> [optional-parameters]
```

## Calling QA Python Tools

The QA Testing Framework self contains all the necessary python modules and by running the _**run_qa_python.sh**_ command the framework will generate a python virtual environment and pull down any necessary dependencies. Tab complete functionality is also added so by calling _**run_qa_python.sh**_ and then using tab, a complete list of available python scripts can be called.

The virtual environment will be created in the `<repor-root>/qa_testing/.venv_qa_testing` directory and all the dependencies will be defined in the `<repor-root>/qa_testing/python/requirements.txt`

### Example: Bringing up a cluster
Run from **_<repo-root>/<cluster-directory> $_**
```
run_qa_python bringup_cluster -t target_cluster
```

### Example: Destroying a cluster
Run from **_<repo-root>/<cluster-directory> $_**
```
run_qa_python bringdown_cluster -t target_cluster
```

## Calling QA Robot Framework Tests

The QA Testing Framework self contains all the necessary robot KubeLibrary Framework dependencies. By running the _**run_qa_robot.sh**_ and tab complete will list the available .robot test files in the `<repor-root>/qa_testing/robot/`

### Example: Execute KubeLibraryTest.robot 
Run from **_<repo-root>/<cluster-directory> $_**
```
run_qa_robot KubeLibraryTest.robot
```