# Quality Assurance (QA) Testing Framework

## I. Summary
The _**qa_testing framework**_ is a collection of tools and scripts for testing the quality and reliability of a running target-cluster. The framework is designed with the end goal of being integrated into a CI/CD pipeline; it is currently configured for local execution against remote target-clusters.

The _**qa_testing directory**_ is self-contained and can be executed from any directory within the repository, specifically from the 'target-cluster' directory (i.e. the 'example' directory). The QA Framework Bash scripts, Python code, and Robot tests that rely on external dependencies are dynamically pulled from remote GitHub or other community resources and stored locally within the _qa_testing .3rd_party_tools_ directory.

_**Note:**_ The system running the QA Framework Tools **_must_** have internet access to dynamically pull needed resources.

The _**qa_testing framework**_ contains the following directories:

- **.3rd_party_tools**: Contains remotely sourced external dependencies.
- **configs**: Contains configuration files for the QA testing framework.
- **documentation**: Contains documentation for the QA testing framework.
- **logs**: Contains log files generated by the QA testing framework.
- **python**: Contains Python code for the QA testing framework.
- **robot**: Contains Robot test cases for the QA testing framework.
- **scripts**: Contains Bash scripts for the QA testing framework.


## II. System Requirements
* **aws-cli** (version >= 2.17)
* **bash** (version >= 5.2)
* **git** (version >= 2.45)
* **ipcalc** (version >= 0.5)
* **jq** (version >= 1.7)
* **kubectl** (version >= v1.30)
* **kustomize** (version >= 5.0)
* **pip** (version >= 23.3)
* **python3** (version >= 3.10)
* **robotframework** (version >= 6.1)
* **xargs** (version >= 4.8)

## III. Get Setup

### A.) Clone Repo & Source .qa_bashrc
1.) Clone and run the Energon-Kube repository locally from this location:

```bash
git clone git@github.com:CMS-Enterprise/Energon-Kube.git
```


2.) Ensure that the terminal is running in a _**bash**_ shell, then set up the current terminal to leverage the QA Testing Framework by sourcing the `.qa_bashrc` file. This allows for calling the QA Testing Framework tools from the main target-cluster directory `<repo-root>/<target-cluster>`. Sourcing the `.qa_bashrc` adds the Bash scripts to the shell path, enabling validation scripts and commands for calling the Python and Robot framework tools. The `<repo-root>` is the complete path where **_Energon-Kube_** is cloned in the local system.

```bash
bash                          # Ensure the terminal is running in bash
cd <repo-root>/qa_testing     # Navigate to the QA Framework directory
source .qa_bashrc             # Source the file to add QA Testing Framework tools to the shell path
```

### B.) Pre-Execution Authentication
* Ensure that your authentication to the target AWS account is configured correctly via your organization’s process and that both `aws-cli` and `kubectl` commands are authenticated in the current bash shell.
* If you do not have a running target-cluster to perform QA tests (such as the **_Smoketest_** validation), you can use the QA Framework's Python **_bringup_cluster_** function to stand up a new cluster. See the **_Example: Bringing up a cluster_** command below. If the target-cluster is already up and running, proceed directly to **_running all the smoketests_** as appropriate.

### Parameter Definitions

* Options in `[ square ]` brackets are optional.
* Options in `< angle >` brackets are required.

## IV. QA Framework Bash Script Tools

Once `.qa_bashrc` has been sourced, change to the target-cluster’s main configuration directory. This is where all commands are expected to be run.


```
cd <repo-root>/<target-cluster>  # Currently, this is the 'example' directory.
```

The **_QA Bash scripts_** are now in the current Bash shell path and can be called directly. There are **_three types of Bash scripts_**:

* Scripts to call QA Smoketest validation tests
* Scripts to call QA Python tools
* Scripts to call QA Robot Framework tests

## V. Smoketest Validation Scripts

### A.) Information
There is a suite of validation scripts that can be run individually or all together using the **_run_smoketest.sh_** command.

**Note:** The `run_smoketest.sh` script will output its log files to the following directory: `<repo-root>/qa_testing/logs/`
* Running **all** tests will output a log file named:
  * `<Date-Time>_run_all_smoketests_on_<target-cluster>_<STATUS>.log`
* Running an individual test will output a log file named:
  * `<Date-Time>_run_<script-name>_on_<target-cluster>_<STATUS>.log`

### B.) Example: Executing the Smoketests

1.) Running all the smoketests:

```
run_smoketest.sh <target-cluster> all
```

2.) Running an individual smoketest:

```
run_smoketest.sh <target-cluster> <script-name.sh>
```


#### Running an Individual Validation Script

* Running individual smoketests is useful when a target-cluster has a specific component that has been upgraded or is in an unstable state. This allows for validation of that specific component without running all tests.
* Additional documentation is available on the Confluence page regarding each individual smoketest at this link: [Cluster Validation Key Test Cases](https://confluenceent.cms.gov/pages/viewpage.action?pageId=745525731).
* The Confluence page contains a table for each individual validation script, including documentation, references to each test case, script names, and any parameters to pass.
* A list of individual smoketests can be found by listing the files in the **_smoketests_** subdirectory:


```
ls <repo-root>/qa_testing/scripts/smoketests`
```

#### Debugging

* If the **_run_smoketest.sh_** script fails, review the error messages and rerun the script after addressing any issues.
* If a smoketest fails, the log file will contain the relevant error message. This can help in debugging issues on the running target-cluster.


### C.) Perform a Complete Smoketest Validation

1.) Ensure that you are in the target-cluster directory.

2.) Run the following command to execute all the smoketests.

3.) Review the smoketest logs:
  * `<Date-Time>_run_all_smoketests_on_<target-cluster>_<STATUS>.log`

```
cd <repo-root>/<target-cluster>                     # Navigate to the target-cluster directory
run_smoketest.sh <target-cluster> all               # Run all the smoketests
ls ../qa_testing/logs/                              # Review the smoketest logs
```

### D.) Perform an Individual Smoketest Validation

1.) Ensure that you are in the target-cluster directory.

2.) Run the following command to execute an individual smoketest.

3.) Review smoketest logs:
   * `<Date-Time>_run_<script-name>_on_<target-cluster>_<STATUS>.log`


```
cd <repo-root>/<cluster-directory>                  # Target-Cluster Directory
run_smoketest.sh <target-cluster> <script-name.sh>  # Run the specified smoketest
ls ../qa_testing/logs/                              # Review the smoketest logs
```


## VI. Calling QA Python Tools

The QA Testing Framework _**self-contains**_ all the necessary Python modules. By running the _**run_qa_py_venv.sh**_ command, the framework generates a Python virtual environment and pulls down any required dependencies. Tab-completion functionality is also available, allowing you to use _**run_qa_py_venv.sh**_ followed by tab to see a complete list of available Python tools. The Python tools are located in the `<repo-root>/qa_testing/python/` directory. This is also where additional Python tools can be developed to integrate with the QA Testing Framework.

The virtual environment is created in the `<repo-root>/qa_testing/.venv_qa_testing` directory, with all dependencies defined in the `<repo-root>/qa_testing/python/requirements.txt`.


Note: Run this script from the target cluster directory: `<repo-root>/<target-cluster>`

### A.) Example: Bringing up a Cluster
```
run_qa_python bringup_cluster -t <target-cluster>
```

### B.) Example: Destroying a Cluster
```
run_qa_py_venv bringdown_cluster -t <target-cluster>
```

## VII. Calling QA Robot Framework Tests

The QA Testing Framework **_self-contains_** all the necessary KubeLibrary Framework dependencies for Robot tests. By running the `run_qa_robot.sh` script, tab completion will list the available `.robot` test files in the `<repo-root>/qa_testing/robot/` directory. This is also where additional Robot tests can be developed and integrated into the QA Testing Framework.

**Note:** Run this script from the target cluster directory: `<repo-root>/<target-cluster>`

### Example: Execute `KubeLibraryTest.robot`

```
run_qa_robot KubeLibraryTest.robot
```